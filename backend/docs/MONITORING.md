# Система мониторинга и алертинга

## Обзор

Данный документ описывает настройку и использование системы мониторинга для приложения. Система включает:

- **Sentry** - мониторинг ошибок и производительности
- **Prometheus** - сбор метрик
- **Alertmanager** - управление алертами
- **Grafana** - визуализация метрик (опционально)

## Настройка окружения

### Необходимые переменные окружения

```env
# Sentry
SENTRY_DSN=your-sentry-dsn
SENTRY_ENVIRONMENT=production
SENTRY_TRACES_SAMPLE_RATE=0.1

# Prometheus
PROMETHEUS_MULTIPROC_DIR=/tmp/prometheus_metrics
METRICS_ENABLED=true
```

## Интеграция с Sentry

### Настройка алертов в Sentry

1. Перейдите в настройки проекта в Sentry
2. Выберите "Alerts" -> "Metric Alerts"
3. Используйте конфигурацию из `sentry_alerts.yml`

### Отслеживаемые события

- Ошибки приложения
- Критические исключения
- Предупреждения о производительности
- Проблемы с внешними сервисами

## Prometheus и метрики

### Доступные метрики

#### HTTP метрики
- `http_requests_total` - общее количество запросов
- `http_request_duration_seconds` - длительность запросов
- `http_requests_in_progress` - текущие выполняющиеся запросы

#### База данных
- `db_queries_total` - общее количество запросов к БД
- `db_query_duration_seconds` - длительность запросов к БД

#### Бизнес-метрики
- `users_total` - общее количество пользователей
- `active_users` - количество активных пользователей

### Настройка сбора метрик

1. Prometheus должен быть настроен на сбор метрик с эндпоинта `/metrics`
2. Частота сбора: 15 секунд
3. Время хранения: 30 дней

## Alertmanager

### Настройка алертов

1. Конфигурация Alertmanager находится в `alertmanager.yml`
2. Правила алертов определены в `prometheus_rules.yml`

### Группы алертов

1. **Критические** - требуют немедленного вмешательства
   - Недоступность сервиса
   - Критические ошибки
   - Проблемы с БД

2. **Предупреждения** - требуют внимания, но не срочно
   - Высокая загрузка CPU/памяти
   - Увеличивающаяся частота ошибок
   - Предупреждения о производительности

## Визуализация (Grafana)

Рекомендуемые дашборды:

1. **Обзор приложения**
   - Статус сервисов
   - Количество запросов
   - Частота ошибок

2. **Производительность**
   - Время отклика API
   - Загрузка серверов
   - Использование ресурсов

3. **Бизнес-метрики**
   - Активные пользователи
   - Конверсии
   - Ключевые показатели эффективности

## Аварийное реагирование

### Эскалация инцидентов

1. **Уровень 1** (Критический)
   - Уведомление в Slack #critical-alerts
   - Уведомление по email
   - Автоматическое создание инцидента в PagerDuty

2. **Уровень 2** (Предупреждение)
   - Уведомление в Slack #alerts
   - Уведомление по email команде разработки

### Процесс реагирования

1. **Обнаружение**
   - Автоматическое оповещение через Alertmanager
   - Ручное создание инцидента через Sentry

2. **Исследование**
   - Анализ логов и метрик
   - Поиск первопричины

3. **Устранение**
   - Временное решение (если применимо)
   - Постоянное исправление

4. **Пост-анализ**
   - Анализ инцидента
   - Действия по предотвращению

## Рекомендации

1. **Логирование**
   - Используйте структурированное логирование
   - Включайте request_id в логи
   - Настройте ротацию логов

2. **Метрики**
   - Измеряйте ключевые метрики бизнеса
   - Настройте базовые уровни (baselines)
   - Отслеживайте аномалии

3. **Алертинг**
   - Избегайте информационного шума
   - Настройте разумные пороги срабатывания
   - Регулярно пересматривайте правила алертинга

## Устранение неполадок

### Общие проблемы

1. **Метрики не отображаются в Prometheus**
   - Проверьте доступность эндпоинта `/metrics`
   - Убедитесь, что Prometheus настроен на сбор метрик

2. **Алерты не срабатывают**
   - Проверьте конфигурацию правил
   - Убедитесь, что Alertmanager запущен и настроен

3. **Высокая нагрузка от мониторинга**
   - Оптимизируйте запросы к БД
   - Увеличьте интервал сбора метрик
   - Используйте агрегацию на стороне клиента

## Контакты

- **Команда DevOps**: devops@yourdomain.com
- **Горячая линия**: +7 (XXX) XXX-XX-XX
- **Чат поддержки**: [Ссылка на чат]
