# Мониторинг KarmaSystem

В этом документе описана настройка и использование системы мониторинга для KarmaSystem.

## Компоненты мониторинга

1. **Prometheus** - сбор и хранение метрик
2. **Grafana** - визуализация метрик и дашборды
3. **Alertmanager** - управление алертами
4. **OpenTelemetry** - сбор трейсов и метрик
5. **Sentry** - отслеживание ошибок

## Быстрый старт

1. Запустите сервисы мониторинга:
   ```bash
   docker-compose -f docker-compose.monitoring.yml up -d
   ```

2. Откройте интерфейсы:
   - Grafana: http://localhost:3000
   - Prometheus: http://localhost:9090
   - Alertmanager: http://localhost:9093

## Метрики приложения

Приложение предоставляет следующие эндпоинты метрик:

- `/metrics` - метрики Prometheus
- `/health` - проверка состояния сервиса
- `/health/liveness` - проверка жизнеспособности
- `/health/readiness` - проверка готовности

## Дашборды Grafana

Доступные дашборды:

1. **KarmaSystem - Application Metrics** - основные метрики приложения
   - HTTP запросы
   - Время отклика
   - Уровень ошибок
   - Метрики базы данных

## Настройка алертов

Алерты настраиваются в файле `prometheus/alerts.yml`. По умолчанию настроены следующие алерты:

- Высокий уровень ошибок (>5%)
- Высокая задержка ответа (>1s)
- Сервис недоступен

## Интеграция с Sentry

Для включения мониторинга ошибок через Sentry установите переменную окружения:

```bash
SENTRY_DSN=your-sentry-dsn
```

## OpenTelemetry

Для включения распределенного трейсинга установите переменные окружения:

```bash
OTEL_EXPORTER_OTLP_ENDPOINT=your-otel-collector:4317
OTEL_SERVICE_NAME=karmasystem-bot
```

## Логирование

Логи настраиваются через переменные окружения:

```bash
LOG_LEVEL=INFO  # DEBUG, INFO, WARNING, ERROR, CRITICAL
LOG_FORMAT=%(asctime)s - %(name)s - %(levelname)s - %(message)s
```

## Масштабирование

Для масштабирования мониторинга:

1. Настройте удаленное хранилище для Prometheus (например, Thanos или Cortex)
2. Включите шардинг в Prometheus
3. Настройте репликацию Alertmanager
4. Используйте Grafana Enterprise для высокой доступности

## Устранение неполадок

1. **Метрики не отображаются в Prometheus**
   - Проверьте, что приложение запущено и доступно
   - Убедитесь, что эндпоинт `/metrics` возвращает данные
   - Проверьте настройки `scrape_configs` в `prometheus.yml`

2. **Алерты не работают**
   - Проверьте конфигурацию Alertmanager
   - Убедитесь, что правила алертов загружены в Prometheus
   - Проверьте логи Alertmanager

3. **Высокая нагрузка на мониторинг**
   - Увеличьте интервалы сбора метрик
   - Уменьшите детализацию метрик
   - Оптимизируйте запросы в PromQL
